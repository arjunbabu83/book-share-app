<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Community Book Sharing</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f9f9f9;
      margin: 0;
      padding: 1rem;
    }
    h1, h2 {
      text-align: center;
      color: #2c3e50;
    }
    form {
      background: white;
      max-width: 500px;
      margin: auto;
      padding: 1rem;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    input, textarea, button {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      border-radius: 5px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    button {
      background-color: #27ae60;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    #bookList {
      max-width: 900px;
      margin: 2rem auto;
    }
    .book {
      background: white;
      margin-bottom: 1rem;
      padding: 1rem;
      border-radius: 10px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
    .book img {
      max-width: 100%;
      height: auto;
      margin-top: 10px;
    }
    .status {
      font-weight: bold;
      color: #2980b9;
    }
    .request-btn {
      margin-top: 10px;
      background: #f39c12;
      color: white;
      border: none;
      padding: 8px;
      border-radius: 5px;
      cursor: pointer;
    }
    .request-form {
      margin-top: 10px;
      padding: 10px;
      background: #f0f0f0;
      border-radius: 5px;
      display: none;
    }
    .request-form input {
      margin-bottom: 10px;
    }
  </style>
</head>
<body>

  <h1>üìö Radiant Shine Community Book Sharing</h1>

  <form id="bookForm">
    <input type="text" name="name" placeholder="Your Name" required />
    <input type="text" name="title" placeholder="Book Title" required />
    <input type="text" name="author" placeholder="Author" required />
    <textarea name="description" placeholder="Brief Description"></textarea>
    <input type="text" name="apartment" placeholder="Apartment Name" required />
    <input type="url" name="imageUrl" placeholder="Image URL (optional)" />
    <button type="submit">üì§ Share Book</button>
  </form>

  <h2>üìñ Available Books</h2>
  <div id="bookList"></div>

  <script>
    // Replace with your deployed Google Apps Script web app URL
    const scriptURL = 'https://script.google.com/macros/s/AKfycbxDbIpIqndUIBoyqxmL1UCCEz88e5va4A_NvfKVYkCYIyQ38NhTP9XORj2njaITpN4M/exec'; // Update after deploying Code.gs

    const form = document.getElementById('bookForm');
    const bookList = document.getElementById('bookList');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(form);
      const data = {
        action: 'share',
        name: formData.get('name'),
        title: formData.get('title'),
        author: formData.get('author'),
        description: formData.get('description'),
        apartment: formData.get('apartment'),
        imageUrl: formData.get('imageUrl'),
        status: 'Available'
      };

      try {
        const response = await fetch(scriptURL, {
          method: 'POST',
          body: JSON.stringify(data),
          headers: { 'Content-Type': 'application/json' },
          mode: 'cors',
          signal: AbortSignal.timeout(10000)
        });
        const result = await response.json();
        console.log('Share book response:', result);
        if (response.ok && result.status === 'success') {
          alert('‚úÖ Book shared successfully!');
          form.reset();
          loadBooks();
        } else {
          throw new Error(result.message || `HTTP ${response.status}: Failed to share book`);
        }
      } catch (err) {
        console.error('Error sharing book:', err);
        alert(`‚ùå Failed to share book: ${err.message}. Please try again.`);
      }
    });

    async function fetchWithRetry(url, options, retries = 3, delay = 1000) {
      for (let i = 0; i < retries; i++) {
        try {
          const response = await fetch(url, {
            ...options,
            signal: AbortSignal.timeout(10000)
          });
          if (!response.ok) {
            const errorText = await response.text();
            console.error(`Fetch failed with status ${response.status}: ${errorText}`);
            throw new Error(`HTTP ${response.status}: ${errorText || 'Server error'}`);
          }
          return response;
        } catch (err) {
          console.warn(`Retrying fetch (${i + 1}/${retries}) due to error: ${err.message}`);
          if (i < retries - 1) {
            await new Promise(resolve => setTimeout(resolve, delay));
          } else {
            throw new Error(`Fetch failed after ${retries} attempts: ${err.message}`);
          }
        }
      }
    }

    async function loadBooks() {
      bookList.innerHTML = '<p>Loading books...</p>';
      try {
        const res = await fetchWithRetry(scriptURL, {
          method: 'GET',
          headers: { 'Content-Type': 'application/json' },
          mode: 'cors'
        });
        let books;
        try {
          books = await res.json();
          console.log('Raw response:', books);
        } catch (err) {
          throw new Error(`Invalid JSON response: ${err.message}`);
        }
        if (!Array.isArray(books)) {
          throw new Error(`Expected an array of books, got: ${JSON.stringify(books)}`);
        }
        if (books.length === 0) {
          bookList.innerHTML = '<p>No books available yet.</p>';
          return;
        }
        bookList.innerHTML = '';
        books.reverse().forEach((book, index) => {
          const status = book.status || 'Available';
          const isAvailable = status.toLowerCase() === 'available';
          bookList.innerHTML += `
            <div class="book" id="book-${index}">
              <strong>${book.title}</strong> by ${book.author}<br>
              <em>Shared by:</em> ${book.name} from ${book.apartment}<br>
              <p>${book.description || ''}</p>
              ${book.imageUrl ? `<img src="${book.imageUrl}" alt="${book.title}">` : ''}
              <p class="status">Status: ${status}</p>
              ${book.requestername ? `<p><em>Requested by:</em> ${book.requestername} (${book.requesteremail})</p>` : ''}
              ${isAvailable ? `
                <button class="request-btn" onclick="showRequestForm(${index}, '${book.title.replace(/'/g, "\\'")}')">Request This Book</button>
                <div class="request-form" id="request-form-${index}">
                  <input type="text" id="requester-name-${index}" placeholder="Your Name" required />
                  <input type="email" id="requester-email-${index}" placeholder="Your Email" required />
                  <button onclick="submitRequest(${index}, '${book.title.replace(/'/g, "\\'")}')">Submit Request</button>
                  <button onclick="hideRequestForm(${index})">Cancel</button>
                </div>
              ` : ''}
            </div>
          `;
        });
      } catch (err) {
        console.error('Error loading books:', err);
        bookList.innerHTML = `<p>‚ö†Ô∏è Failed to load books: ${err.message}. Please check the script URL or try again later.</p>`;
      }
    }

    function showRequestForm(index, title) {
      document.getElementById(`request-form-${index}`).style.display = 'block';
      document.getElementById(`book-${index}`).querySelector('.request-btn').style.display = 'none';
    }

    function hideRequestForm(index) {
      document.getElementById(`request-form-${index}`).style.display = 'none';
      document.getElementById(`book-${index}`).querySelector('.request-btn').style.display = 'block';
    }

    async function submitRequest(index, title) {
      const requesterName = document.getElementById(`requester-name-${index}`).value;
      const requesterEmail = document.getElementById(`requester-email-${index}`).value;
      if (!requesterName || !requesterEmail) {
        alert('‚ùå Please provide both name and email.');
        return;
      }

      const data = {
        action: 'request',
        title: title,
        requesterName: requesterName,
        requesterEmail: requesterEmail
      };

      try {
        const response = await fetch(scriptURL, {
          method: 'POST',
          body: JSON.stringify(data),
          headers: { 'Content-Type': 'application/json' },
          mode: 'cors',
          signal: AbortSignal.timeout(10000)
        });
        const result = await response.json();
        console.log('Request book response:', result);
        if (response.ok && result.status === 'success') {
          alert('‚úÖ Book request submitted successfully!');
          hideRequestForm(index);
          loadBooks();
        } else {
          throw new Error(result.message || `HTTP ${response.status}: Failed to submit request`);
        }
      } catch (err) {
        console.error('Error requesting book:', err);
        alert(`‚ùå Failed to submit request: ${err.message}. Please try again.`);
      }
    }

    if (!scriptURL || scriptURL === 'https://script.google.com/macros/s/AKfycbxDbIpIqndUIBoyqxmL1UCCEz88e5va4A_NvfKVYkCYIyQ38NhTP9XORj2njaITpN4M/exec') {
      bookList.innerHTML = '<p>‚ö†Ô∏è Error: Please configure the correct Google Apps Script web app URL.</p>';
      console.error('Invalid scriptURL. Update the scriptURL constant with the deployed web app URL.');
    } else {
      loadBooks();
    }
  </script>

</body>
</html>
